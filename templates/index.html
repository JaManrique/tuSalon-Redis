<!DOCTYPE html>
<html>
    <head>
        <!-- Vue.js -->
        <script src="https://unpkg.com/vue@2.4.2"></script>
        <!-- Axios for requests -->
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    </head>
    <body>
        <div id='app'>
            <div id='banner'>
            </div>
            <div id='classroom'>
            </div>
            <div id ='other'>
                %{info}%

                -------------------

                %{freeClassrooms}%
            </div>
        </div>
        <script>

            var jsInfo = {{jsonInfo|tojson|safe}};

            var app = new Vue
            ({
                el: "#app",
                delimiters: ['%{', '}%'],
                data: {
                    info: JSON.parse(jsInfo),
                    freeClassrooms: [],
                    freeClassroom: "",
                    date: new Date()
                },

                methods: {
                    classroomNow: function(json, date)
                    {
                        //First part of the method generates day schedule from base json
                        classrooms = this.info
                        exceptions = []
                        localClassrooms = {}
                        today = this.generateDate(date)
                        for(classroom in classrooms)
                        {
                            schedule = []
                            exceptions = classrooms[classroom]["exceptions"][today]
                            if(exceptions != undefined)
                            {
                                //The 'today' field contains a string with the format "SCH$$SCH$$ (...)"
                                console.log("Exceptions " + classroom + ":")
                                console.log(exceptions)
                                console.log(exceptions.split("$$"))
                                schedule.concat(exceptions.split("$$"))
                            }
                            //This line converts to a JS object but the string is not optimally formed, so it has to replace
                            // ' ocurrences with " to be a valid json to parse
                            base = JSON.parse(classrooms[classroom][(date.getDay()-1).toString()].replace(/\'/g, '\"'))

                            for(sch in base)
                                schedule.push(base[sch])
                            
                            localClassrooms[classroom] = schedule
                        }

                        //Second part, finds free classrooms from previous data structure formed

                        console.log("Local classrooms: ")
                        console.log(localClassrooms)

                        hour = date.getHours()*100 + date.getMinutes()

                        for(classroom in localClassrooms)
                        {
                            //Warden variable, modeling that the hour belongs to the tuple
                            warden = true
                            for(continuityTuple in localClassrooms[classroom])
                            {
                                continuity_tuple = localClassrooms[classroom][continuityTuple].split(/ - /g)
                                console.log("Non split: " + localClassrooms[classroom][continuityTuple])
                                console.log("Splitted: " + continuity_tuple)
                                //Checks if given hour is within continuityTuple
                                if(this.isInCountinuityTuple(hour, continuity_tuple))
                                {
                                    //If so, it means that the classroom is occupied, thus, there's no need to check
                                    //if it's within another tuple (and continue with the next classroom)
                                    warden = false
                                    break
                                }
                            }

                            //If the warden remains true, the hour is not in any tuple of the classrooms
                            //schedules, meaning it's free! (eureka!)
                            //TODO add time left for classroom to be occupied (very important)
                            if (warden)
                            {
                                this.freeClassrooms.push(classroom)
                            }
                        }
                    },

                    generateDate: function(date)
                    {
                        return date.getDate() + "/" + (date.getMonth()+1) + "/" + date.getFullYear()
                    },

                    isInCountinuityTuple: function(hour, tuple)
                    {
                        //A continuity tuple is defined as a continous time interval in which the classroom is occupied.
                        //The method just checks if the given hour is between the boundaries of the given tuple

                        //tuple[0] is the lower boundary
                        //tuple[1] is the uppper boundary

                        //If the hour is bigger than the lower boundary
                        if(hour > parseInt(tuple[0]))
                        {
                            //and is lower than the upper boundary
                            if(hour < parseInt(tuple[1]))
                            {
                                //Then, it means that it is within the boundaries
                                return true
                            }
                        }
                        return false
                    }
                },

                //Method called just after the instance is created
                created: function()
                {
                    //Performance testing
                    temp = new Date()
                    time = temp.getTime()

                    this.classroomNow(this.info, this.date)

                    temp = new Date()
                    time = temp.getTime() - time
                    console.log("Performance: " + time + "ms")
                    console.log(this.freeClassrooms)
                }
            
            })            
    
        </script>
    </body>
</html>