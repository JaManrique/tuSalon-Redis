<!DOCTYPE html>
<html>
    <head>
        <!-- Vue.js -->
        <script src="https://unpkg.com/vue@2.4.2"></script>
        <!-- Axios for requests -->
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    </head>
    <body>
        <div id='app'>
            <div id='banner'>

                <h1> Tu salon v0.0 </h1>

            </div>
            <div id='classroom'>
            </div>
            <div id ='other'>
                %{freeClassrooms}%
                <li v-for:'clazzroom in freeClassrooms'>
                    %{formatFreeClassroom(clazzroom)}%
                </li>
            </div>
        </div>
        <script>

            var app = new Vue
            ({
                el: "#app",
                delimiters: ['%{', '}%'],
                data: {
                    info: null,
                    freeClassrooms: [],
                    freeClassroom: "",
                    date: new Date()
                },

                methods: 
                {
                    classroomNow: function(date)
                    {
                        //First part of the method generates day schedule from base json
                        classrooms = this.info
                        exceptions = []
                        localClassrooms = {}
                        today = this.generateDate(date)
                        for(classroom in classrooms)
                        {
                            schedule = []
                            exceptions = classrooms[classroom]["exceptions"][today]
                            console.log("Exceptions " + classroom + " // " + today + ":")
                            console.log(exceptions)
                            if(exceptions != undefined)
                            {
                                //The 'today' field contains a string with the format "SCH$$SCH$$ (...)"
                                //TODO error may be on month/day format (AGO = 08 and not 8, etc.)
                                schedule.concat(exceptions.split("$$"))
                            }
                            //This line converts to a JS object but the string is not optimally formed, so it has to replace
                            // ' ocurrences with " to be a valid json to parse
                            base = JSON.parse(classrooms[classroom][(date.getDay()-1).toString()].replace(/\'/g, '\"'))

                            for(sch in base)
                                schedule.push(base[sch])
                            
                            localClassrooms[classroom] = schedule
                        }

                        //Second part, finds free classrooms from previous data structure formed

                        console.log("Local classrooms: ")
                        console.log(localClassrooms)

                        hour = date.getHours()*100 + date.getMinutes()

                        for(classroom in localClassrooms)
                        {
                            //Warden variable, modeling that the hour belongs to the tuple
                            warden = true

                            //Variable that saves the shortest (but positive) difference betweeen
                            //the first element of all cointinuity tuples
                            timeUntilOccupation = 9000
                            for(continuityTuple in localClassrooms[classroom])
                            {
                                continuity_tuple = localClassrooms[classroom][continuityTuple].split(/ - /g)

                                //console.log("Non split: " + localClassrooms[classroom][continuityTuple])
                                //console.log("Splitted: " + continuity_tuple)

                                //Checks if given hour is within continuityTuple
                                if(this.isInCountinuityTuple(hour, continuity_tuple))
                                {
                                    //If so, it means that the classroom is occupied, thus, there's no need to check
                                    //if it's within another tuple (and continue with the next classroom)
                                    warden = false
                                    break
                                }

                                //Compares actual continuity tuple difference with the actual best aproximation
                                difference = parseInt(continuity_tuple[0]) - hour

                                if(difference > 0 && difference<timeUntilOccupation)
                                    timeUntilOccupation = difference
                            }

                            //If the warden remains true, the hour is not in any tuple of the classrooms
                            //schedules, meaning it's free! (eureka!)
                            if (warden)
                            {
                                //Creates an object with classroom id as a key and time until occupation as value
                                if(timeUntilOccupation == 9000)
                                    timeUntilOccupation = "Hasta el final del dÃ­a"
                                classroomObject = {}
                                classroomObject[classroom] = timeUntilOccupation
                                this.freeClassrooms.push(classroomObject)
                            }

                            //Note that if the class is not free, timeUntilOcupation's value is irrelevant
                            //(for now)
                        }
                    },

                    generateDate: function(date)
                    {
                        day = date.getDate()
                        if(day < 10)
                            day = "0" + day
                        month = date.getMonth()+1
                        if(month < 10)
                            month = "0" + month
                        return day + "/" + month + "/17"
                    },

                    //@TODO Correct empty interval-emptiness 
                    //(technically all classrooms are free between classes)
                    isInCountinuityTuple: function(hour, tuple)
                    {
                        //A continuity tuple is defined as a continous time interval in which the classroom is occupied.
                        //The method just checks if the given hour is between the boundaries of the given tuple

                        //tuple[0] is the lower boundary
                        //tuple[1] is the uppper boundary

                        //If the hour is bigger than the lower boundary
                        if(hour > parseInt(tuple[0]))
                        {
                            //and is lower than the upper boundary
                            if(hour < parseInt(tuple[1]))
                            {
                                //Then, it means that it is within the boundaries
                                return true
                            }
                        }
                        return false
                    },

                    formatFreeClassroom: function(classroom)
                    {
                        for(id in classroom)
                            return id + " Libre hasta " + classroom[id]
                    }
                },

                //Method called just after the instance is created
                mounted: function()
                {
                    //Using a pointer to this due to the context change on axios function
                    var localThis = this
                    axios.get('/salones').then(function (response) 
                    {
                        console.log(response.data)
                        localThis.info = response.data

                        //Performance testing
                        temp = new Date()
                        time = temp.getTime()

                        localThis.classroomNow(localThis.date)

                        temp = new Date()
                        time = temp.getTime() - time
                        console.log("Performance: " + time + "ms")
                        console.log(localThis.freeClassrooms)

                    }).catch (function (error) 
                    {
                        console.log(error)
                    })
                }
            
            })            
    
        </script>
    </body>
</html>